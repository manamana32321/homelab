apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: factorio
  namespace: argocd
spec:
  project: default
  destination:
    namespace: factorio
    server: https://kubernetes.default.svc
  sources:
    # Git manifests (secrets, pvc, ofsm)
    - repoURL: https://github.com/manamana32321/homelab.git
      targetRevision: main
      path: k8s/argocd/applications/factorio
      directory:
        recurse: true
        exclude: "application.yaml"
    # Helm chart (Factorio server)
    - chart: factorio-server-charts
      repoURL: https://sqljames.github.io/factorio-server-charts
      targetRevision: 2.5.2
      helm:
        valuesObject:
          # 이미지 버전 고정
          image:
            tag: "2.0.72"

          # 서비스 설정 (NodePort)
          service:
            type: NodePort
            port: 34197
            nodePort: 31497

          # 리소스 설정
          resources:
            requests:
              memory: 1024Mi
            limits:
              memory: 2048Mi
              cpu: 1000m

          # 스토리지 설정 (공유 PVC 사용)
          persistence:
            dataDir:
              Size: "4Gi"
              existingClaim: factorio-data

          # 팩토리오 서버 설정
          factorioServer:
            save_name: "default"

          # 게임 비밀번호 (SealedSecret 참조)
          serverPassword:
            passwordSecret: factorio-server-password

          # 서버 설정
          server_settings:
            name: "JSON"
            description: "JSON Factorio Space Age Server"
            tags:
              - space-age
              - private
            autosave_slots: 20

          # RCON 활성화 (OFSM 연결용)
          rcon:
            external: true
            passwordSecret: factorio-rcon-password
            port: 27015

          # 맵 생성 설정 (자원 크기 600%)
          map_gen_settings:
            autoplace_controls:
              coal:
                size: 6
              stone:
                size: 6
              copper-ore:
                size: 6
              iron-ore:
                size: 6
              uranium-ore:
                size: 6
              crude-oil:
                size: 6

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - PrunePropagationPolicy=foreground
